stepback: true
exec_timeout_secs: 3600

buildvariants:
    - display_name: NOTICE distro
      name: zzztest-tag1-small
      run_on:
          - zzztest-tag1-small
      tasks:
          - name: no-token
    - display_name: Tests
      name: ubuntu
      run_on:
          - ubuntu2204-small
      tasks:
          - name: first-task
          - name: another-task
          - name: long-task
          - name: short-task
          - name: oops-another-task
          - name: noise-task-1
          - name: noise-task-2
          - name: noise-task-3
          - name: generator
          - name: task-group
          - name: task-d
          - name: task-e
          - name: github.generate_token1
          - name: github.generate_token2
          - name: github.generate_token3
          - name: no-token
          - name: redacting-expansions

functions:
    clone-project:
        command: git.get_project
        params:
            directory: src

task_groups:
  - name: task-group
    max_hosts: 2
    tasks:
      - task-a
      - task-b
      - task-c

tasks:
    - name: task-a
      patchable: false
      commands:
          - command: shell.exec
            params:
                script: "echo hello world"
    - name: task-b
      patch_only: true
      commands:
          - command: shell.exec
            params:
                script: "echo hello world"
    - name: task-c
      commands:
          - command: shell.exec
            params:
                script: "echo hello world"
      # depends_on: # depends on test
      #     - task-d
      #     - task-e
    - name: task-d
      patchable: false
      commands:
          - command: shell.exec
            params:
                script: "echo hello world"
    - name: task-e
      patchable: false
      commands:
          - command: shell.exec
            params:
                script: "echo hello world"
    - name: first-task
      commands:
          - command: shell.exec
            params:
                script: |
                    echo "Task"
                    # exit 1 #1
    - name: another-task
      commands:
          - command: shell.exec
            params:
                script: |
                    echo "Task"
                    # exit 1 #2
    - name: long-task
      commands:
          - command: shell.exec
            params:
                script: |
                    echo "Task"
                    # exit 1 #8
    - name: short-task
      commands:
          - command: shell.exec
            params:
                script: |
                    echo "Task"
                    # exit 1 #5
    - name: oops-another-task
      commands:
          - command: shell.exec
            params:
                script: |
                    echo "Task"
                    # exit 1 #7
    - name: noise-task-1
      commands:
          - command: shell.exec
            params:
                script: |
                    echo "Task"
                    exit 0
    - name: noise-task-2
      commands:
          - command: shell.exec
            params:
                script: |
                    echo "Task"
                    exit 0
    - name: noise-task-3
      commands:
          - command: shell.exec
            params:
                script: |
                    echo "Task"
                    exit 0
    - name: generator
      commands:
          - func: clone-project
          - command: generate.tasks
            params:
                files:
                    - src/generator.json
    - name: github.generate_token1
      commands:
          - command: github.generate_token
            params:
                owner: evergreen-ci
                repo: github-merge-queue-sandbox
                expansion_name: testing_expansion1
          - command: shell.exec
            params:
                script: |
                    echo ${testing_expansion1}
                    git clone https://oauth2:${testing_expansion1}@github.com/evergreen-ci/github-merge-queue-sandbox.git evg1
    - name: github.generate_token2
      commands:
          - command: github.generate_token
            params:
                owner: evergreen-ci
                repo: github-merge-queue-sandbox
                expansion_name: testing_expansion2
                permissions: # In theory, this should strip it of contents. and this task should fail.
                    checks: read
          - command: shell.exec
            params:
                script: |
                    echo ${testing_expansion2}
                    git clone https://oauth2:${testing_expansion2}@github.com/evergreen-ci/github-merge-queue-sandbox.git evg1
    - name: github.generate_token3
      commands:
          - command: github.generate_token
            params:
                expansion_name: testing_expansion2
          - command: shell.exec
            params:
                script: |
                    echo ${testing_expansion2}
                    git clone https://oauth2:${testing_expansion2}@github.com/evergreen-ci/github-merge-queue-sandbox.git evg1
    - name: no-token
      commands:
          - command: shell.exec
            params:
                script: |
                    git clone https://github.com/evergreen-ci/github-merge-queue-sandbox.git evg1
    - name: redacting-expansions
      commands:
          - func: clone-project
          - command: expansions.update
            params:
                updates:
                    - key: testing_expansion2
                      value: "expansion#2 says hi"
                    - key: testing_expansion4
                      value: "expansion#4 says hi"
          - command: expansions.update
            params:
                updates:
                    - key: testing_expansion1
                      value: "expansion#1 says hi"
                    - key: testing_expansion2
                      concat: " let me add on to that!"
                    - key: testing_expansion3
                      value: "expansion#3 says hi"
                      redact: true
                    - key: testing_expansion4
                      concat: " let me add on to that!"
                      redact: true
          - command: expansions.update
            params:
                file: expansions.yaml
          - command: expansions.update
            params:
                file: expansions.yaml
                redact_file_expansions: true
          - command: shell.exec
            params:
                script: |
                    echo "Expansion #1"
                    echo ${testing_expansion1}
                    echo "Expansion #2"
                    echo ${testing_expansion2}
                    echo "Expansion #3"
                    echo ${testing_expansion3}
                    echo "Expansion #4"
                    echo ${testing_expansion4}
                    echo "File expansion #1"
                    echo ${expansion_key_1}
                    echo "File expansion #2"
                    echo ${expansion_key_2}
                    echo "File expansion #3"
                    echo ${expansion_key_3}
                    echo "File expansion #4"
                    echo ${expansion_key_4}